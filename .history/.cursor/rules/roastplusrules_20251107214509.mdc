---
alwaysApply: true
---
# RoastPlus プロジェクト固有ルール

## プロジェクト概要
RoastPlusは、コーヒー豆加工業務をサポートするためのWebアプリです。チーム、メンバー、タスクラベルの管理と、それらの割り当て機能、またスケジュール管理や、試飲感想記録を提供します。

## 運用環境
- **デバイス構成**: 1つのアカウントを9台のデバイスで運用（iPad 1台、スマートフォン 8台）
- **マルチデバイス対応**: 同一アカウントで複数デバイスから同時アクセス可能
- **リアルタイム同期**: Firestoreの`onSnapshot`により、全デバイス間でデータがリアルタイムに同期
- **PWA対応**: Service WorkerとWeb App Manifestにより、ホーム画面に追加可能なPWAとして動作
- **オフライン対応**: Service Workerにより、オフライン時も基本的な機能が利用可能

## 技術スタック
- **フレームワーク**: Next.js 16.0.1
- **UIライブラリ**: React 19.2.0
- **言語**: TypeScript 5
- **スタイリング**: Tailwind CSS 4
- **バックエンド**: Firebase (Authentication + Firestore)
- **ビルド**: 本番環境では静的エクスポート (`output: 'export'`)

## アーキテクチャの原則

### データ管理
- Firestoreを使用してユーザーごとのデータを分離管理
- データ構造は `AppData` 型で定義（`src/types/index.ts`）
- 各ユーザーのデータは `/users/{userId}` パスに保存
- Firestoreセキュリティルールで、ユーザーは自分のデータのみアクセス可能

### ファイル構造
- `src/app/`: Next.js App Routerのページコンポーネント
- `src/components/`: 再利用可能なReactコンポーネント
- `src/hooks/`: カスタムフック（`useAuth`, `useAppData`など）
- `src/lib/`: ユーティリティ関数とFirebase設定
- `src/types/`: TypeScript型定義

### 認証とセキュリティ
- Firebase Authenticationを使用
- 環境変数でFirebase設定を管理（`NEXT_PUBLIC_FIREBASE_*`）
- Firestoreセキュリティルールで認証チェックを実施
- ユーザーIDは `request.auth.uid` で取得

## コーディング規約

### TypeScript
- 型定義は `src/types/index.ts` に集約
- 既存の型定義を尊重し、一貫性を保つ
- `any` の使用を避け、適切な型を定義

### React/Next.js
- Server Componentsを優先し、必要に応じてClient Componentsを使用
- カスタムフックでロジックを分離（`useAppData`, `useAuth`）
- コンポーネントは小さく、単一責任の原則に従う

### スタイリング
- Tailwind CSS 4を使用
- インラインクラスでスタイルを記述
- 再利用可能なスタイルはコンポーネント化を検討
- **レスポンシブデザイン**: iPadとスマートフォンの両方で快適に使用できるよう、画面サイズに応じたレイアウトを実装
- **タッチ操作最適化**: ボタンやインタラクティブ要素は、タッチ操作に適したサイズ（最小44x44px）を確保

### Firebase操作
- Firestore操作は `src/lib/firestore.ts` に集約
- エラーハンドリングを適切に実装
- リアルタイム更新には `onSnapshot` を使用
- **マルチデバイス同期**: 複数デバイス間でのデータ競合を避けるため、Firestoreのトランザクションやサーバータイムスタンプを活用

## データモデル

### 主要な型
- `Team`: チーム情報
- `Member`: メンバー情報（`teamId`で所属チームを参照、`excludedTaskLabelIds`で除外ラベルを管理）
- `TaskLabel`: タスクラベル（`leftLabel`と`rightLabel`でペアを表現）
- `Assignment`: 現在の割り当て（`memberId`が`null`の場合は未割り当て）
- `AssignmentHistory`: 割り当て履歴

### データ操作の原則
- データの追加・更新・削除は不変性を保つ（スプレッド演算子を使用）
- 削除時は関連データも適切に処理（例: チーム削除時はメンバーと割り当ても削除）
- データ操作関数は `src/lib/firestore.ts` に定義

## ビルドとデプロイ

### 開発環境
- `npm run dev` で開発サーバー起動（ポート3000）
- 通常のNext.js開発モードを使用

### 本番環境
- `npm run build` で静的エクスポートを生成
- `output: 'export'` により静的HTMLファイルを生成
- 画像は `unoptimized: true` で最適化を無効化（静的エクスポートの制約）
- ビルド出力は `roast-plus/out` ディレクトリに生成される

### Firebase Hosting
- **デプロイ先**: Firebase Hosting
- **設定ファイル**: `firebase.json` の `hosting` セクションで設定
- **公開ディレクトリ**: `roast-plus/out`（Next.jsの静的エクスポート出力先）
- **SPAルーティング**: `rewrites` で全てのリクエストを `/index.html` にリダイレクト
- **デプロイコマンド**: `firebase deploy --only hosting`（プロジェクトルートから実行）
- **webmanifest**: `.webmanifest` ファイルに適切なContent-Typeヘッダーを設定

## エラーハンドリング

### Firebase操作
- Firestore操作のエラーは適切にキャッチし、ログに記録
- エラー時はデフォルトデータを返すか、ユーザーに通知

### データ検証
- データ読み込み時の型チェックを実施
- 存在しないデータの場合はデフォルトデータを返す

## パフォーマンス

### Firestore
- リアルタイムリスナーは適切にクリーンアップ（`Unsubscribe`を返す）
- 不要なリスナーは解除してメモリリークを防止
- **マルチデバイス最適化**: 9台のデバイスが同時に接続することを考慮し、不要なリスナーを避ける
- **オフライン対応**: Service Workerにより、ネットワーク接続が不安定な環境でも動作

### React
- 不要な再レンダリングを避ける
- カスタムフックで状態管理を最適化
- **モバイルパフォーマンス**: スマートフォンのリソース制約を考慮し、軽量な実装を心がける

### PWA機能
- Service Workerは本番環境でのみ有効化（`process.env.NODE_ENV === 'production'`）
- Web App Manifest（`site.webmanifest`）でPWA設定を管理
- オフライン時の動作を考慮した実装

## セキュリティ

### 環境変数
- Firebase設定は環境変数で管理（`.env.local`に配置）
- `NEXT_PUBLIC_` プレフィックスはクライアント側で公開されるため注意

### Firestoreルール
- `firestore.rules` でユーザーごとのデータアクセスを制限
- 認証済みユーザーのみが自分のデータにアクセス可能

## 開発時の注意事項

### 新機能追加時
- 既存のデータ構造との互換性を考慮
- 型定義を更新し、既存コードとの整合性を保つ
- Firestoreセキュリティルールの更新が必要な場合は確認
- **マルチデバイス対応**: 新機能は複数デバイス間での動作を確認
- **レスポンシブデザイン**: iPadとスマートフォンの両方で適切に表示されることを確認
- **タッチ操作**: モバイルデバイスでの操作性を考慮したUI設計

### リファクタリング時
- `src/lib/firestore.ts` の関数インターフェースを維持（既存コードとの互換性）
- データ操作の不変性を保つ
- テストを追加または更新

## その他

### 依存関係
- 新規ライブラリ追加時は、プロジェクトの制約を確認
- 静的エクスポートとの互換性を考慮

### コメントとドキュメント
- 複雑なロジックにはコメントを追加
- 関数の目的とパラメータを明確に記述![1762519488208](image/roastplusrules/1762519488208.png)![1762519489778](image/roastplusrules/1762519489778.png)![1762519492736](image/roastplusrules/1762519492736.png)![1762519494778](image/roastplusrules/1762519494778.png)![1762519494992](image/roastplusrules/1762519494992.png)![1762519495241](image/roastplusrules/1762519495241.png)![1762519500818](image/roastplusrules/1762519500818.png)![1762519505030](image/roastplusrules/1762519505030.png)![1762519505772](image/roastplusrules/1762519505772.png)![1762519505984](image/roastplusrules/1762519505984.png)![1762519506230](image/roastplusrules/1762519506230.png)![1762519507462](image/roastplusrules/1762519507462.png)![1762519507660](image/roastplusrules/1762519507660.png)![1762519507854](image/roastplusrules/1762519507854.png)![1762519508041](image/roastplusrules/1762519508041.png)